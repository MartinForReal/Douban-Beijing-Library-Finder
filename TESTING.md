# 测试指南 - 豆瓣图书馆助手

本文档提供详细的测试步骤和验证清单。

## 前置条件

- ✅ 已安装 Node.js 16+
- ✅ 已安装依赖：`npm install`
- ✅ 已构建扩展：`npm run dev`
- ✅ 已在 Edge 中加载扩展（edge://extensions）

## 1. 构建验证

### 1.1 检查构建输出

```bash
npm run dev
```

**预期结果**：
- 终端输出 `✓ Build completed (development mode)`
- `dist/` 文件夹包含以下文件：
  - `manifest.json`
  - `src/content/douban-content.js`
  - `src/background/service-worker.js`
  - `icons/` 文件夹（即使为空）

### 1.2 验证文件完整性

```bash
# 在项目根目录运行
ls -la dist/
```

**检查清单**：
- [ ] manifest.json 存在且大小 > 0
- [ ] douban-content.js 存在且大小 > 1KB
- [ ] service-worker.js 存在且大小 > 0.5KB

## 2. 扩展加载验证

### 2.1 加载扩展

1. 打开 Microsoft Edge
2. 输入 `edge://extensions`
3. 启用 **开发者模式**（右上角开关）
4. 点击 **加载解包的扩展程序**
5. 选择 `dist` 文件夹

**预期结果**：
- 扩展成功加载，显示在扩展列表中
- 扩展ID生成（例如：`abcdefghijklmnopqrstuvwxyzabcdef`）
- 无错误提示

### 2.2 检查扩展详情

1. 在 edge://extensions 中找到该扩展
2. 查看详情信息

**验证项**：
- [ ] 扩展名称：豆瓣图书馆助手
- [ ] 版本号：1.0.0
- [ ] 状态：已启用
- [ ] 权限：Script、Tab、Host permissions

## 3. 功能测试

### 3.1 测试用例 #1 - 可借书籍

**URL**：https://book.douban.com/subject/1291546/（《活着》 by 余华）

**测试步骤**：
1. 打开上述链接
2. 向下滚动到右侧 **购买信息** 区域
3. 观察是否有蓝色按钮注入

**预期结果**：
- [ ] 在右侧信息栏出现 **蓝色"📚 嘉图借阅"按钮**
- [ ] 按钮可点击，点击后打开嘉图云详情页
- [ ] 浏览器控制台（F12）显示日志：`[Library Extension] Found ISBN: ...`

---

### 3.2 测试用例 #2 - 不可借或无馆藏

**URL**：https://book.douban.com/subject/25843208/（《三体》by 刘慈欣）

**测试步骤**：
1. 打开上述链接
2. 向下滚动到右侧信息栏
3. 检查是否有提示信息

**预期结果**（两种可能之一）：
- [ ] 出现 **灰色提示框**："嘉图云图书馆暂无可借" + "查看馆藏详情"链接
- 或 [ ] 显示 **可借数量**：例如"可借 2 本"和蓝色按钮

**记录**：
- 书籍ISBN：_______________
- 嘉图云响应：_______________

---

### 3.3 测试用例 #3 - 无ISBN的页面

**URL**：https://book.douban.com/（首页或无ISBN的页面）

**测试步骤**：
1. 打开豆瓣首页
2. 检查是否注入任何元素

**预期结果**：
- [ ] 页面保持原状，**无任何提示或按钮**
- [ ] 浏览器控制台显示日志：`[Library Extension] No ISBN found on this page`

---

### 3.4 测试用例 #4 - 多次访问

**测试步骤**：
1. 访问某本书的详情页（例如用例#1）
2. 观察按钮显示
3. 刷新页面
4. 再次观察按钮

**预期结果**：
- [ ] 第一次访问：按钮正确显示
- [ ] 刷新后：按钮仍然正确显示
- [ ] **无重复按钮**（没有多个相同的按钮）
- [ ] 控制台无错误信息

---

## 4. 边界情况测试

### 4.1 API 超时测试

**测试步骤**：
1. 打开开发者工具（F12）→ Network 标签
2. 设置网络限流（Slow 3G 或 Offline 模式）
3. 访问豆瓣书籍详情页
4. 观察扩展行为

**预期结果**：
- [ ] 扩展 **不会崩溃**
- [ ] 如果 API 超时，按钮**不显示**
- [ ] 控制台显示错误日志：`[Library Extension] API Error: ...`

---

### 4.2 网络错误测试

**测试步骤**：
1. 断开网络或使用代理阻止 apps.jiatu.cloud
2. 访问豆瓣书籍详情页
3. 观察扩展行为

**预期结果**：
- [ ] 扩展 **不会崩溃**
- [ ] 页面正常加载，仅扩展功能不可用
- [ ] 控制台显示错误日志

---

### 4.3 特殊ISBN格式

**测试步骤**：
1. 找到带有不同ISBN格式的书籍（例如ISBN-10 vs ISBN-13）
2. 访问详情页
3. 检查扩展是否正确处理

**预期结果**：
- [ ] 无论ISBN格式如何，扩展都能正确提取
- [ ] API 调用成功
- [ ] 控制台日志显示正确的ISBN

---

## 5. 开发者工具调试

### 5.1 查看 Content Script 日志

1. 打开豆瓣书籍详情页
2. 按 **F12** 打开开发者工具
3. **Console** 标签中查看日志

**关键日志**（按顺序出现）：
```
[Library Extension] Found ISBN: 9787020042494
[Library Extension] Button injected successfully
```

**错误日志示例**：
```
[Library Extension] No ISBN found on this page
[Library Extension] Injection error: ...
```

---

### 5.2 查看 Service Worker 日志

1. 打开 `edge://extensions`
2. 找到扩展，点击 **检查视图** 或 **背景页**
3. 在弹出的开发者工具中查看 Console

**预期日志**：
```
[Library Extension] Extension installed
[Library Extension] Health check: Extension is running
```

---

### 5.3 查看 Network 请求

1. 打开豆瓣书籍详情页，F12 打开开发者工具
2. **Network** 标签
3. 查看对 `apps.jiatu.cloud` 的请求

**检查项**：
- [ ] 请求 URL：`https://apps.jiatu.cloud/client/book/detail`
- [ ] 请求方法：POST
- [ ] 请求体包含：`isbn`、`libcode`、`channel`、`timestamp`、`salt`、`sign`
- [ ] 响应状态：200 OK
- [ ] 响应包含 `success: true` 或 `success: false`

---

## 6. UI 和样式测试

### 6.1 按钮样式验证

**可借按钮**：
- [ ] 颜色：蓝色（#2E7FBE）
- [ ] 文本：📚 嘉图借阅
- [ ] 鼠标悬停：颜色变深（#1F5F96）
- [ ] 宽度：占满容器
- [ ] 内边距：12px
- [ ] 圆角：4px

**不可借提示框**：
- [ ] 背景色：浅灰色（#F5F5F5）
- [ ] 左边框：灰色（4px, #CCCCCC）
- [ ] 文字颜色：深灰色（#666）
- [ ] "查看馆藏详情"链接：蓝色，鼠标悬停时有下划线

---

### 6.2 响应式设计测试

**测试步骤**：
1. 访问豆瓣书籍详情页
2. 调整浏览器窗口宽度（从窄到宽）
3. 观察按钮/提示框

**预期结果**：
- [ ] 所有尺寸下按钮都正确显示和对齐
- [ ] 文本不会被截断
- [ ] 布局不会破裂

---

## 7. 性能测试

### 7.1 页面加载时间

**测试步骤**：
1. 打开开发者工具 → Performance 标签
2. 访问豆瓣书籍详情页
3. 记录页面加载时间

**预期结果**：
- [ ] 扩展**不会显著增加**页面加载时间
- [ ] DOM 操作在 **200ms 以内** 完成
- [ ] 无长时间的阻塞操作

---

### 7.2 内存使用

**测试步骤**：
1. 打开豆瓣书籍详情页多个标签页（5-10个）
2. 打开开发者工具 → Memory 标签
3. 记录内存使用

**预期结果**：
- [ ] 每个标签页额外占用 < 5MB 内存
- [ ] 无明显内存泄漏

---

## 8. 兼容性测试

### 8.1 浏览器版本

**测试环境**：
- [ ] Microsoft Edge 版本 _____ (应为 v88+)

**预期结果**：
- [ ] 扩展在该版本正常运行

---

### 8.2 豆瓣网站更新

**测试步骤**：
如果豆瓣更新了网站结构，重新检查：
- [ ] `.buyinfo` 选择器是否仍有效
- [ ] JSON-LD 中的 `isbn` 字段是否仍存在
- [ ] 注入位置是否仍合适

**如有变化**：
- 更新 `src/content/douban-content.ts` 中的选择器或逻辑
- 重新构建并测试

---

## 9. 测试总结表

| 测试项 | 通过 | 失败 | 备注 |
|--------|------|------|------|
| 构建完成 | [ ] | [ ] | |
| 扩展加载 | [ ] | [ ] | |
| 可借书籍 | [ ] | [ ] | |
| 不可借书籍 | [ ] | [ ] | |
| 无ISBN页面 | [ ] | [ ] | |
| 多次访问 | [ ] | [ ] | |
| API超时 | [ ] | [ ] | |
| 网络错误 | [ ] | [ ] | |
| 特殊ISBN | [ ] | [ ] | |
| 按钮样式 | [ ] | [ ] | |
| 响应式设计 | [ ] | [ ] | |
| 性能测试 | [ ] | [ ] | |

---

## 10. 常见问题排查

| 症状 | 可能原因 | 解决方案 |
|------|---------|--------|
| 按钮不显示 | 扩展未启用 | 检查 edge://extensions 中扩展状态 |
| 按钮不显示 | ISBN提取失败 | 查看F12控制台日志 |
| 按钮不显示 | API调用失败 | 检查网络连接和嘉图云服务状态 |
| 重复按钮 | MutationObserver未正确处理 | 刷新扩展 |
| 样式不正确 | CSS被豆瓣样式覆盖 | 在douban-content.ts中添加!important |
| 脚本错误 | TypeScript编译问题 | 运行npm run dev重新构建 |

---

## 完成检查

所有测试完成后，确认：

- [ ] 所有功能测试通过
- [ ] 无控制台错误
- [ ] UI显示正确
- [ ] 性能满足要求
- [ ] 扩展可稳定使用

**测试人员**: __________  
**测试日期**: __________  
**最终状态**: ✅ 通过 / ❌ 需改进